> * 原文地址：https://blog.logrocket.com/how-css-works-parsing-painting-css-in-the-critical-rendering-path-b3ee290762d3

> * 译文地址：

> * 译者：

> * 校对者：

# CSS是如何工作的：关键渲染路径中的CSS解析和渲染

CSS像是由一股神奇的力量，控制着web页面上的所有可见的东西。有时，它可以很简单，然而想要写出可拓展、高性能的CSS缺一点也不容易。

不管你是否认为CSS是”必经之痛”或者认为它有能力但是被误解，CSS对于web开发者而言都是必须掌握的能力。对CSS的深入理解可能就会导致你的网站是一个光鲜亮丽的网站还是一个普通网站


这篇文章是深入了解CSS及其附属生态意系列的第一篇。通过先开CSS神秘的面纱，获得更深的理解和欣赏这门web实质上的样式语言，让我们可以写出更快、更干净、更漂亮的CSS代码来适应我们应用的体量和复杂度的成长。

作为该系列的第一篇文章，我们将要研究页面初次加载后，CSS是如何被渲染到屏幕上的。

我们关心从CSS到像素的渲染过程的原因，归结为两个词

**加载时间**

如果你的网站加载很慢，即使它内容很有价值，用户可能不会等到它加载完就离开了。一些研究表明，页面加载时间超过3s则会导致超过50%的用户的离开。

基于这个用户期望，作为web开发者，我们有责任不要增加用户加载的时间。不幸的是，CSS通常是导致加载时间增加的罪魁祸首，所以如果你对CSS是如何被渲染到像素的有细致的了解，将会帮助你优化这关键的几秒，提升用户的留存。

#### 然而，什么事关键渲染路径?

当我们说，用户想要更快的加载时间，我们要区分关键资源和非关键资源。也许你正在使用lazy loading来加载你的图片或者根据路由拆分，不一次性加载所有脚本。这些资源在页面初次渲染完成后加载，被认为是非关键资源，它们不会推迟初次渲染的时间。那些会推迟初次渲染时间的资源才是关键资源。

关键渲染路径是当浏览器收到HTML第一个字节起到开始渲染像素所要经历的最少步骤。本质上，它是浏览器处理并渲染关键资源，展示给用户的过程。大致如下：

* 1.创建DOM（文档对象模型）
* 2.如果遇到CSS（内联或者外链）创建CSSOM（CSS对象模型—后面将会说到）
* 3.如果在创建DOM的时候遇到JS代码块（不是异步的），等待CSSOM构建，停止DOM构建，解析和执行代码。这么做的原因是JS执行过程中，可能会修改DOM并且访问或者修改CSSOM

这篇文章的目的是深入研究第二个步骤—CSS是如何影响关键渲染路径的。我们很容易意识到要，Tree-shake、路由拆分、懒加载JS代码，但是经常遗忘CSS。然而，未优化的CSS很容易导致加载时间的增加。

#### HTML和关键渲染路径

既然我们的重点是CSS，我们不会话太多篇幅在DOM构建上。然而，CSS是一个样式描述语言，所以我们要知道它是如何和DOM工作的。

DOM是树形结构，包含页面上所有的HTML节点。每一个节点包含了HTML元素的数据（比如属性、id、class）。如果HTML元素有子节点，它会指向这些子节点。比如，下图中的HTML将会构建出右边的DOM结构。会发现HTML的缩进和DOM结构的十分相似

![](https://luoleiorg.b0.upaiyun.com/source/translation/1.png)

就关键渲染路径而言，我们认为HTML是一个阻碍渲染的关键资源。当我们没有解析完之前不能开始渲染。

#### 创建CSS对象模型

当浏览器解析到一个CSS样式表（不管是内联还是外链），需要解析文本，使之可以用于样式排布和绘制。这种数据结构就是CSSOM

CSSOM长什么样子？下图中的CSS将会构建出右边的CSSOM

![](https://luoleiorg.b0.upaiyun.com/source/translation/2.png)

本质上，我们通过解析所有的CSS选择器并将它插入到树中对应的位置。如果是一个单独的选择器，将会被添加到树的根节点下。嵌套的选择器将会被添加到嵌套的节点下。CSS解析器将会从右往左遍历选择器来保证其正确性。

解析CSS到CSSOM和通过HTML构建DOM一样，是一个阻碍渲染的过程。如果不等待CSSOM的构建而开始渲染，将会导致一个瞬间，用户看到没有样式的内容，然后被应用上CSS的样式，这不是一个好的用户体验。

#### 渲染树

浏览器用构建好的CSSOM和DOM来创建一个渲染树。简单来说，渲染树包含了需要渲染像素到屏幕上的所有信息。浏览器将DOM和CSSOM整合到一起，移除了对渲染输出没有影响的内容。


首先，浏览器移除了所有不可见元素。包括<head><script><meta>这些标签，以及有 hidden 属性的HTML元素。这些元素虽然在其他地方有用到，但是并不会渲染到页面上，所以浏览器可以保证渲染树上的所有节点都为可见的然后安全的进行渲染。

然后，遍历CSSOM，找到与渲染树上节点相匹配的CSS选择器。任何匹配到的CSS规则将会被应用到该节点上

有一个例外的CSS规则， display: none; 在CSS规则里，将会从渲染树上完全移除，这会回到渲染树阶段，只保留可见元素。其他隐藏元素的方法，如 opacity: 0; 将不会从渲染树种移除接点，仅仅是不展示。

![](https://luoleiorg.b0.upaiyun.com/source/translation/3.png)

这样，我们就拥有了一颗渲染树。在我们整合完CSSOM和DOM到渲染树后，浏览器就可以用它并且认为渲染树精确的包含了所有需要被渲染成像素的信息，没有多余、也没有缺少信息。

#### 冲刺阶段：排版和绘制

配备了完整的渲染树，浏览器已经可以开始渲染像素到屏幕上了。关键渲染路径的最后阶段包括两个步骤：排版和绘制

排版是浏览器判断元素的位置和所需的空间，通过计算影响 marign padding width position 的规则。在计算排版的时候，浏览器从渲染树的顶端向下遍历，因为元素的位置、宽度、高度是由其父元素计算而来的

如果你对CSS盒子模型很熟悉的话，浏览器在页面上绘制了一系列CSS盒子（如果你想要了解盒子模型，可以阅读这篇） [here](https://developer.mozilla.org/en-US/docs/Learn/CSS/Introduction_to_CSS/Box_model)).

然而，要记住，这个时候页面上还没有显示任何内容。想象成仅仅是在视窗上绘制了轮廓线，等待开始填充。

排版之后就是绘制阶段，然后我们就可以看到内容被渲染到页面上！如果你以渲染第一个像素为终点，那绘制就是终点线。浏览器遍历非布局的CSS规则并且填充CSS盒子。如果你用了多个图层，浏览器会保证其绘制到正确的图层。

请记住，一些CSS属性对页面负载有很大影响（比如，radial-gradient 比纯色渲染就更为复杂）。如果你在绘制过程中发现一些闪跳，减少这种渲染代价高的CSS规则可以显著提高网站的性能。

#### 为什么要关心关键渲染路径中的CSS?

你可以花尽可能多的时间来优化网站的FPS（每秒的渲染帧数），使它看起来更好，或者通过A-B test来获得更高的转化率。但是如果你的用户在页面加载完整前离开了，这些将于事无补。

如果你在尝试提高页面加载速度，知道浏览器需要哪些步骤才能渲染出第一像素是至关重要的。既然浏览器在解析全部CSS之前会阻碍渲染，那么可以在HTML文档中去掉那些不会在首次页面渲染中使用到的CSS文件。这么做可以大幅度降低浏览器构建CSSOM和渲染树的时间。

那些在初次加载中并非必要的CSS可以被认为是非关键资源。可以通过懒加载，在用户看到初次渲染页面之后再加载（如果你的页面是一个单页应用，这将会特别重要，传送那些还看不到页面的CSS对性能有很大影响）

理解CSSOM是如果构建的另一个好处是对选择器性能有了更深入的了解。既然嵌套的选择器必须检查CSSOM上的父节点，那么避免使用嵌套选择器的扁平的CSSOM的性能会更高一些。然而，我想说的是，在大多数场景下，它并不会成为性能的瓶颈，对比重写CSS选择器，还有其他更值得优化的地方。

和其他web性能相关的问题一样，在修改CSS之前，你最好可以分析下加载时间。如果你在使用Chrome，打开工具栏切换到 Perfomarnce 标签下。你可以通过 Recalculate Styles, Layout, and Paint 这些事件，看到CSSOM构建、排版、绘制所需的时间。然后你可以根据瓶颈来针对性的开始优化。



